<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de M煤ltiples Mundos - Three.js</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
        }

        /* Pantalla de carga */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        #loading-screen.active {
            opacity: 1;
            pointer-events: all;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 24px;
            margin-top: 20px;
            font-weight: bold;
        }

        /* UI Info */
        #ui-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 100;
        }

        #ui-info h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
        }

        #ui-info p {
            margin: 5px 0;
        }

        .key {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* Prompt de interacci贸n */
        #interaction-prompt {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 100;
        }

        #interaction-prompt.visible {
            opacity: 1;
        }

        .prompt-key {
            background: #4caf50;
            padding: 5px 15px;
            border-radius: 5px;
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <div id="loading-screen">
        <div class="loader"></div>
        <div class="loading-text">Cargando...</div>
    </div>

    <div id="ui-info">
        <h3 id="world-name"> Mundo: Exterior</h3>
        <p><span class="key">W A S D</span> - Mover</p>
        <p><span class="key">E</span> - Interactuar</p>
        <p><span class="key">Mouse</span> - Mirar alrededor</p>
    </div>

    <div id="interaction-prompt">
        Presiona <span class="prompt-key">E</span> para entrar
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // Variables globales
        var scene, camera, renderer;
        var currentWorld = 'exterior';
        var worlds = {};
        var player = {
            position: new THREE.Vector3(0, 1, 5),
            rotation: new THREE.Euler(0, 0, 0),
            velocity: new THREE.Vector3(),
            speed: 0.1
        };
        var keys = {};
        var mouse = { x: 0, y: 0 };
        var isPointerLocked = false;
        var canInteract = false;
        var nearDoor = null;

        // Inicializar
        function init() {
            // Escena
            scene = new THREE.Scene();

            // C谩mara
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.copy(player.position);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Crear mundos
            createExteriorWorld();
            createInteriorWorld();

            // Cargar mundo inicial
            loadWorld('exterior');

            // Luces
            setupLights();

            // Eventos
            setupEvents();

            // Iniciar animaci贸n
            animate();
        }

        // Crear mundo exterior
        function createExteriorWorld() {
            var exteriorGroup = new THREE.Group();
            exteriorGroup.name = 'exterior';

            // Suelo exterior
            var groundGeo = new THREE.PlaneGeometry(50, 50);
            var groundMat = new THREE.MeshStandardMaterial({ 
                color: 0x7cb342,
                roughness: 0.8
            });
            var ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            exteriorGroup.add(ground);

            // Casa exterior
            var houseGeo = new THREE.BoxGeometry(6, 4, 6);
            var houseMat = new THREE.MeshStandardMaterial({ color: 0xd4a574 });
            var house = new THREE.Mesh(houseGeo, houseMat);
            house.position.set(0, 2, -5);
            house.castShadow = true;
            house.receiveShadow = true;
            exteriorGroup.add(house);

            // Techo
            var roofGeo = new THREE.ConeGeometry(5, 2, 4);
            var roofMat = new THREE.MeshStandardMaterial({ color: 0x8b4513 });
            var roof = new THREE.Mesh(roofGeo, roofMat);
            roof.position.set(0, 5, -5);
            roof.rotation.y = Math.PI / 4;
            roof.castShadow = true;
            exteriorGroup.add(roof);

            // Puerta (trigger de interacci贸n)
            var doorGeo = new THREE.BoxGeometry(1.5, 2.5, 0.2);
            var doorMat = new THREE.MeshStandardMaterial({ color: 0x5d4a3a });
            var door = new THREE.Mesh(doorGeo, doorMat);
            door.position.set(0, 1.25, -1.9);
            door.userData.isDoor = true;
            door.userData.leadsTo = 'interior';
            exteriorGroup.add(door);

            // rboles decorativos
            for (var i = 0; i < 8; i++) {
                var treePos = new THREE.Vector3(
                    Math.random() * 30 - 15,
                    0,
                    Math.random() * 30 - 15
                );
                if (treePos.distanceTo(new THREE.Vector3(0, 0, -5)) > 8) {
                    var tree = createTree();
                    tree.position.copy(treePos);
                    exteriorGroup.add(tree);
                }
            }

            worlds.exterior = exteriorGroup;
        }

        // Crear mundo interior
        function createInteriorWorld() {
            var interiorGroup = new THREE.Group();
            interiorGroup.name = 'interior';

            // Suelo interior
            var floorGeo = new THREE.PlaneGeometry(5.5, 5.5);
            var floorMat = new THREE.MeshStandardMaterial({ 
                color: 0x8b6f47,
                roughness: 0.9
            });
            var floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            interiorGroup.add(floor);

            // Paredes
            var wallMat = new THREE.MeshStandardMaterial({ color: 0xf5deb3 });
            
            // Pared trasera
            var backWall = new THREE.Mesh(new THREE.BoxGeometry(6, 4, 0.2), wallMat);
            backWall.position.set(0, 2, -3);
            backWall.receiveShadow = true;
            interiorGroup.add(backWall);

            // Pared izquierda
            var leftWall = new THREE.Mesh(new THREE.BoxGeometry(0.2, 4, 6), wallMat);
            leftWall.position.set(-3, 2, 0);
            leftWall.receiveShadow = true;
            interiorGroup.add(leftWall);

            // Pared derecha
            var rightWall = new THREE.Mesh(new THREE.BoxGeometry(0.2, 4, 6), wallMat);
            rightWall.position.set(3, 2, 0);
            rightWall.receiveShadow = true;
            interiorGroup.add(rightWall);

            // Techo
            var ceiling = new THREE.Mesh(new THREE.PlaneGeometry(6, 6), wallMat);
            ceiling.rotation.x = Math.PI / 2;
            ceiling.position.y = 4;
            ceiling.receiveShadow = true;
            interiorGroup.add(ceiling);

            // Mesa
            var tableMat = new THREE.MeshStandardMaterial({ color: 0x654321 });
            var tableTop = new THREE.Mesh(new THREE.BoxGeometry(2, 0.1, 1), tableMat);
            tableTop.position.set(-1, 0.8, -1.5);
            tableTop.castShadow = true;
            interiorGroup.add(tableTop);

            // Patas de mesa
            for (var i = 0; i < 4; i++) {
                var leg = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.8), tableMat);
                var x = i < 2 ? -0.9 : -0.1;
                var z = i % 2 === 0 ? -0.9 : -0.4;
                leg.position.set(x, 0.4, z);
                leg.castShadow = true;
                interiorGroup.add(leg);
            }

            // Silla
            var chairMat = new THREE.MeshStandardMaterial({ color: 0x8b4513 });
            var chairSeat = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.1, 0.5), chairMat);
            chairSeat.position.set(-1, 0.5, -0.5);
            chairSeat.castShadow = true;
            interiorGroup.add(chairSeat);

            var chairBack = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.6, 0.1), chairMat);
            chairBack.position.set(-1, 0.85, -0.75);
            chairBack.castShadow = true;
            interiorGroup.add(chairBack);

            // Puerta de salida
            var exitDoorGeo = new THREE.BoxGeometry(1.5, 2.5, 0.2);
            var exitDoorMat = new THREE.MeshStandardMaterial({ color: 0x5d4a3a });
            var exitDoor = new THREE.Mesh(exitDoorGeo, exitDoorMat);
            exitDoor.position.set(0, 1.25, 2.9);
            exitDoor.userData.isDoor = true;
            exitDoor.userData.leadsTo = 'exterior';
            interiorGroup.add(exitDoor);

            worlds.interior = interiorGroup;
        }

        // Crear 谩rbol simple
        function createTree() {
            var tree = new THREE.Group();
            
            // Tronco
            var trunkGeo = new THREE.CylinderGeometry(0.2, 0.3, 2);
            var trunkMat = new THREE.MeshStandardMaterial({ color: 0x4a3728 });
            var trunk = new THREE.Mesh(trunkGeo, trunkMat);
            trunk.position.y = 1;
            trunk.castShadow = true;
            tree.add(trunk);

            // Copa
            var foliageGeo = new THREE.SphereGeometry(1.2, 8, 8);
            var foliageMat = new THREE.MeshStandardMaterial({ color: 0x228b22 });
            var foliage = new THREE.Mesh(foliageGeo, foliageMat);
            foliage.position.y = 2.5;
            foliage.castShadow = true;
            tree.add(foliage);

            return tree;
        }

        // Configurar luces
        function setupLights() {
            var ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            var dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 20, 10);
            dirLight.castShadow = true;
            dirLight.shadow.camera.left = -20;
            dirLight.shadow.camera.right = 20;
            dirLight.shadow.camera.top = 20;
            dirLight.shadow.camera.bottom = -20;
            scene.add(dirLight);
        }

        // Cargar mundo
        function loadWorld(worldName) {
            showLoadingScreen(true);

            setTimeout(function() {
                // Limpiar escena
                while(scene.children.length > 0) { 
                    scene.remove(scene.children[0]); 
                }

                // Agregar nuevo mundo
                scene.add(worlds[worldName]);
                setupLights();

                // Actualizar posici贸n del jugador
                if (worldName === 'interior') {
                    player.position.set(0, 1, 2);
                    player.rotation.y = Math.PI;
                } else {
                    player.position.set(0, 1, 5);
                    player.rotation.y = 0;
                }

                camera.position.copy(player.position);
                camera.rotation.y = player.rotation.y;

                currentWorld = worldName;
                document.getElementById('world-name').textContent = 
                    ' Mundo: ' + (worldName === 'exterior' ? 'Exterior' : 'Interior de la Casa');

                showLoadingScreen(false);
            }, 1000);
        }

        // Mostrar pantalla de carga
        function showLoadingScreen(show) {
            var loadingScreen = document.getElementById('loading-screen');
            if (show) {
                loadingScreen.classList.add('active');
            } else {
                loadingScreen.classList.remove('active');
            }
        }

        // Configurar eventos
        function setupEvents() {
            document.addEventListener('keydown', function(e) {
                keys[e.key.toLowerCase()] = true;
                
                if (e.key.toLowerCase() === 'e' && canInteract && nearDoor) {
                    loadWorld(nearDoor.userData.leadsTo);
                }
            });

            document.addEventListener('keyup', function(e) {
                keys[e.key.toLowerCase()] = false;
            });

            document.addEventListener('click', function() {
                renderer.domElement.requestPointerLock();
            });

            document.addEventListener('pointerlockchange', function() {
                isPointerLocked = document.pointerLockElement === renderer.domElement;
            });

            document.addEventListener('mousemove', function(e) {
                if (isPointerLocked) {
                    player.rotation.y -= e.movementX * 0.002;
                    player.rotation.x -= e.movementY * 0.002;
                    player.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, player.rotation.x));
                }
            });

            window.addEventListener('resize', function() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // Actualizar jugador
        function updatePlayer() {
            var direction = new THREE.Vector3();
            
            if (keys['w']) direction.z -= 1;
            if (keys['s']) direction.z += 1;
            if (keys['a']) direction.x -= 1;
            if (keys['d']) direction.x += 1;

            if (direction.length() > 0) {
                direction.normalize();
                direction.applyAxisAngle(new THREE.Vector3(0, 1, 0), player.rotation.y);
                
                player.position.x += direction.x * player.speed;
                player.position.z += direction.z * player.speed;
            }

            // L铆mites del mundo
            if (currentWorld === 'exterior') {
                player.position.x = Math.max(-20, Math.min(20, player.position.x));
                player.position.z = Math.max(-20, Math.min(20, player.position.z));
            } else {
                player.position.x = Math.max(-2.5, Math.min(2.5, player.position.x));
                player.position.z = Math.max(-2.5, Math.min(2.5, player.position.z));
            }

            camera.position.copy(player.position);
            camera.rotation.set(player.rotation.x, player.rotation.y, 0);

            checkDoorProximity();
        }

        // Verificar proximidad a puertas
        function checkDoorProximity() {
            var worldGroup = worlds[currentWorld];
            var playerPos = player.position.clone();
            canInteract = false;
            nearDoor = null;

            worldGroup.children.forEach(function(child) {
                if (child.userData.isDoor) {
                    var distance = playerPos.distanceTo(child.position);
                    if (distance < 2) {
                        canInteract = true;
                        nearDoor = child;
                    }
                }
            });

            var prompt = document.getElementById('interaction-prompt');
            if (canInteract) {
                prompt.classList.add('visible');
                prompt.textContent = nearDoor.userData.leadsTo === 'interior' 
                    ? 'Presiona E para entrar' 
                    : 'Presiona E para salir';
                prompt.innerHTML = prompt.textContent.replace('E', '<span class="prompt-key">E</span>');
            } else {
                prompt.classList.remove('visible');
            }
        }

        // Animaci贸n
        function animate() {
            requestAnimationFrame(animate);
            updatePlayer();
            renderer.render(scene, camera);
        }

        // Iniciar
        init();
    </script>
</body>
</html>